#!/bin/sh
# Pre-commit hook: run quality checks before each commit
# Install: npx husky install && npx husky add .husky/pre-commit

set -e

echo "ğŸ” Running pre-commit checks..."

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 1. Check for console.log in staged frontend files
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
STAGED_TS=$(git diff --cached --name-only --diff-filter=ACM | grep -E 'frontend/src/.*\.(ts|tsx)$' | grep -v '\.test\.' | grep -v '__tests__' || true)
if [ -n "$STAGED_TS" ]; then
  CONSOLE_FOUND=0
  for file in $STAGED_TS; do
    if grep -n 'console\.\(log\|debug\|info\)' "$file" 2>/dev/null; then
      echo "âš ï¸  console statement found in: $file"
      CONSOLE_FOUND=1
    fi
  done
  if [ "$CONSOLE_FOUND" -eq 1 ]; then
    echo "âš ï¸  Warning: console statements detected in staged files (not blocking)"
  fi
fi

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 2. TypeScript type check on staged frontend files
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if [ -n "$STAGED_TS" ]; then
  echo "ğŸ“ Running TypeScript check..."
  (cd frontend && npx tsc --noEmit 2>&1) || {
    echo "âŒ TypeScript check failed. Fix type errors before committing."
    exit 1
  }
  echo "âœ… TypeScript check passed"
fi

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 3. Run contract tests if contract files changed
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
STAGED_CONTRACTS=$(git diff --cached --name-only --diff-filter=ACM | grep -E '(contracts/.*\.clar|tests/.*\.test\.ts)$' || true)
if [ -n "$STAGED_CONTRACTS" ]; then
  echo "ğŸ§ª Running contract tests..."
  npm test 2>&1 || {
    echo "âŒ Contract tests failed. Fix tests before committing."
    exit 1
  }
  echo "âœ… Contract tests passed"
fi

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 4. Run frontend tests if frontend files changed
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
STAGED_FRONTEND=$(git diff --cached --name-only --diff-filter=ACM | grep -E 'frontend/src/.*\.(ts|tsx)$' || true)
if [ -n "$STAGED_FRONTEND" ]; then
  echo "ğŸ§ª Running frontend tests..."
  (cd frontend && npx vitest run --pool=forks 2>&1) || {
    echo "âŒ Frontend tests failed. Fix tests before committing."
    exit 1
  }
  echo "âœ… Frontend tests passed"
fi

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 5. Check for large files
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
LARGE_FILES=$(git diff --cached --name-only --diff-filter=ACM | xargs -I{} sh -c 'test -f "{}" && wc -c < "{}"' 2>/dev/null | awk '$1 > 1048576' || true)
if [ -n "$LARGE_FILES" ]; then
  echo "âš ï¸  Warning: Large files detected (>1MB). Consider using Git LFS."
fi

echo "âœ… Pre-commit checks passed!"
